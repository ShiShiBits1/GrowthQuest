{% extends "base.html" %}

{% block title %}给孩子添加积分{% endblock %}

{% block content %}
<h1>给孩子添加积分</h1>

<form method="POST">
    <div class="form-group">
        <label for="child_id">选择孩子</label>
        <select id="child_id" name="child_id" required>
            <option value="" disabled selected>请选择孩子</option>
            {% for child in children %}
                <option value="{{ child.id }}">{{ child.name }} (当前积分: {{ child.points }})</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label for="task_id">选择任务</label>
        <select id="task_id" name="task_id" required>
            <option value="" disabled selected>请选择任务</option>
            {% for task in tasks %}
                <option value="{{ task.id }}" data-points="{{ task.points }}">{{ task.name }} ({{ task.category }})</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label for="points_input">奖励积分</label>
        <input type="number" id="points_input" name="points_input" placeholder="选择任务后显示默认积分，或手动输入自定义积分" min="0">
    </div>
    
    <div class="form-group">
        <label for="date">日期时间</label>
        <input type="datetime-local" id="date" name="date" value="{{ today }}" required>
    </div>
    
    <button type="submit" class="button">添加积分</button>
</form>

<script>
        // 实现任务选择与积分的联动功能
        document.getElementById('task_id').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const points = selectedOption.getAttribute('data-points');
            document.getElementById('points_input').value = points;
        });
        
        // 页面加载时，如果已有任务选中，显示对应的积分
        window.addEventListener('load', function() {
            const taskSelect = document.getElementById('task_id');
            if (taskSelect.value) {
                const selectedOption = taskSelect.options[taskSelect.selectedIndex];
                const points = selectedOption.getAttribute('data-points');
                document.getElementById('points_input').value = points;
            }
        });
        
        // 使用AJAX异步获取过滤后的任务列表
        document.getElementById('child_id').addEventListener('change', function() {
            updateTasksList();
        });
        
        document.getElementById('date').addEventListener('change', function() {
            updateTasksList();
        });
        
        function updateTasksList() {
            const childId = document.getElementById('child_id').value;
            const dateInput = document.getElementById('date').value;
            const taskSelect = document.getElementById('task_id');
            
            // 只有当孩子和日期都选择了才发送请求
            if (!childId || !dateInput) {
                return;
            }
            
            // 从日期时间字符串中提取日期部分 (YYYY-MM-DD)
            const date = dateInput.split('T')[0];
            
            // 清空任务列表并添加加载中选项
            taskSelect.innerHTML = '<option value="" disabled selected>加载中...</option>';
            
            // 发送AJAX请求
            fetch(`/api/get_filtered_tasks?child_id=${childId}&date=${date}`)
                .then(response => response.json())
                .then(data => {
                    // 清空任务选择框
                    taskSelect.innerHTML = '<option value="" disabled selected>请选择任务</option>';
                    
                    if (data.error) {
                        // 显示错误信息
                        const errorOption = document.createElement('option');
                        errorOption.value = '';
                        errorOption.disabled = true;
                        errorOption.textContent = '加载失败: ' + data.error;
                        taskSelect.appendChild(errorOption);
                    } else if (data.tasks && data.tasks.length > 0) {
                        // 添加任务选项
                        data.tasks.forEach(task => {
                            const option = document.createElement('option');
                            option.value = task.id;
                            option.setAttribute('data-points', task.points);
                            option.textContent = `${task.name} (${task.category})`;
                            taskSelect.appendChild(option);
                        });
                    } else {
                        // 没有可用任务
                        const noTaskOption = document.createElement('option');
                        noTaskOption.value = '';
                        noTaskOption.disabled = true;
                        noTaskOption.textContent = '当天没有可用任务';
                        taskSelect.appendChild(noTaskOption);
                    }
                    
                    // 重置积分输入框
                    document.getElementById('points_input').value = '';
                })
                .catch(error => {
                    // 显示错误信息
                    taskSelect.innerHTML = '<option value="" disabled selected>请选择任务</option>';
                    const errorOption = document.createElement('option');
                    errorOption.value = '';
                    errorOption.disabled = true;
                    errorOption.textContent = '网络错误，请重试';
                    taskSelect.appendChild(errorOption);
                    console.error('Error fetching tasks:', error);
                });
        }
    </script>
{% endblock %}