{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2 class="text-center my-4">{{ resource.title }}</h2>
    
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <!-- 学习内容展示区域 -->
                    <div class="learning-content mb-4">
                        {% if resource.resource_type == '视频' and resource.content_url %}
                        <!-- 视频播放器 -->
                        <video id="learning-video" width="100%" controls>
                            <source src="{{ resource.content_url }}" type="video/mp4">
                            您的浏览器不支持视频播放
                        </video>
                        {% elif resource.resource_type == '文章' and resource.content_url %}
                        <!-- 文章内容 -->
                        <iframe src="{{ resource.content_url }}" width="100%" height="500px" frameborder="0"></iframe>
                        {% elif resource.content_url %}
                        <!-- 其他类型资源 -->
                        <a href="{{ resource.content_url }}" target="_blank" class="btn btn-primary btn-lg btn-block">
                            打开学习资源
                        </a>
                        {% else %}
                        <div class="alert alert-warning">
                            资源链接暂不可用
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- 进度条 -->
                    {% if child == current_user %}
                    <div class="progress-section mb-4">
                        <div class="row mb-1">
                            <div class="col-6">学习进度:</div>
                            <div class="col-6 text-right font-weight-bold">{{ progress.progress|int }}%</div>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-primary" 
                                 role="progressbar" 
                                 style="width: {{ progress.progress }}%" 
                                 aria-valuenow="{{ progress.progress }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <!-- 资源信息 -->
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5 class="card-title">资源信息</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <strong>分类:</strong> {{ resource.category.name }}
                                </li>
                                <li class="list-group-item">
                                    <strong>类型:</strong> {{ resource.resource_type }}
                                </li>
                                <li class="list-group-item">
                                    <strong>难度:</strong> {{ resource.difficulty_level if resource.difficulty_level else '难度适中' }}
                                </li>
                                <li class="list-group-item">
                                    <strong>时长:</strong> 
                                    {% if resource.duration %}
                                    {{ resource.duration // 60 }}分{{ resource.duration % 60 }}秒
                                    {% else %}
                                    未知时长
                                    {% endif %}
                                </li>
                                {% if progress %}
                                <li class="list-group-item">
                                    <strong>访问次数:</strong> {{ progress.access_count }}
                                </li>
                                <li class="list-group-item">
                                    <strong>最后学习:</strong> {{ progress.last_accessed.strftime('%Y-%m-%d %H:%M') }}
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 资源描述 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>资源详情</h5>
        </div>
        <div class="card-body">
            <p>{{ resource.description }}</p>
        </div>
    </div>
    
    <div class="text-center mt-4">
        <a href="{{ url_for('main.learning_category', category_id=resource.category_id) }}{% if child %}?child_id={{ child.id }}{% endif %}" 
           class="btn btn-outline-secondary">
            返回分类列表
        </a>
    </div>
</div>

{% if child == current_user %}
<script>
// 进度更新函数
function updateProgress() {
    var video = document.getElementById('learning-video');
    if (!video) return;
    
    var duration = video.duration || {{ resource.duration or 0 }};
    var currentTime = video.currentTime;
    var progress = (currentTime / duration) * 100;
    
    // 发送进度更新请求
    fetch('{{ url_for('main.update_learning_progress') }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: new URLSearchParams({
            'resource_id': '{{ resource.id }}',
            'progress': progress,
            'last_watched_time': currentTime
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('进度更新失败:', data.message);
        }
    })
    .catch(error => {
        console.error('进度更新请求失败:', error);
    });
}

// 视频播放事件监听
var video = document.getElementById('learning-video');
if (video) {
    // 初始设置播放位置
    if ({{ progress.last_watched_time if progress else 0 }}) {
        video.currentTime = {{ progress.last_watched_time if progress else 0 }};
    }
    
    // 定期更新进度
    setInterval(updateProgress, 10000); // 每10秒更新一次
    
    // 视频结束时更新进度
    video.addEventListener('ended', function() {
        updateProgress();
        alert('恭喜你完成了这个学习资源！获得了积分奖励！');
    });
    
    // 页面关闭前更新进度
    window.addEventListener('beforeunload', updateProgress);
}
</script>
{% endif %}
{% endblock %}